<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>HubTube</title>

<style>
body{
 background:#0f0f0f;
 color:white;
 font-family:Arial;
 margin:0
}

.header{
 display:flex;
 gap:10px;
 padding:10px;
 background:#181818;
 align-items:center
}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
 gap:10px;
 padding:10px
}

.card{
 background:#181818;
 padding:10px;
 border-radius:10px;
 cursor:pointer
}

input,button,textarea{
 background:#222;
 color:white;
 border:1px solid #333;
 padding:6px;
 margin:3px
}

video{
 background:black;
 max-height:70vh
}

.playerBox{
 max-width:900px;
 margin:auto
}

.comment{
 background:#181818;
 padding:6px;
 margin:4px 0
}

</style>
</head>

<body>

<div class="header">
<button onclick="show('main')">–ì–ª–∞–≤–Ω–∞—è</button>
<button onclick="show('upload')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
<button onclick="show('studio')">–ú–æ—è —Å—Ç—É–¥–∏—è</button>

<input id="search" placeholder="–ü–æ–∏—Å–∫" oninput="load()"/>

<span id="user">–≥–æ—Å—Ç—å</span>

<button onclick="login()">–í—Ö–æ–¥</button>
<button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- –ì–õ–ê–í–ù–ê–Ø -->
<div id="main" class="grid"></div>

<!-- –ü–õ–ï–ï–† -->
<div id="player" style="display:none" class="playerBox">

<video id="videoPlayer" controls style="width:100%"></video>

<h2 id="vTitle"></h2>

<div style="display:flex;gap:10px;align-items:center">

<button onclick="likeVideo()">üëç <span id="likes">0</span></button>

<button onclick="subChannel()">
–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è <span id="subs">0</span>
</button>

<span>üëÅ <span id="views">0</span></span>

</div>

<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>

<textarea id="cText"></textarea><br>
<button onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<div id="comments"></div>

<h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
<div id="recs" class="grid"></div>

</div>

<!-- –ó–ê–ì–†–£–ó–ö–ê -->
<div id="upload" style="display:none;padding:10px">

<h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h3>

<input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/><br>

<textarea id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea><br>

–û–±–ª–æ–∂–∫–∞:<input type="file" id="thumb"/><br>
–í–∏–¥–µ–æ:<input type="file" id="file"/><br>

<button onclick="upload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<!-- –°–¢–£–î–ò–Ø -->
<div id="studio" style="display:none;padding:10px"></div>

<script type="module">

import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import{
getAuth,createUserWithEmailAndPassword,
signInWithEmailAndPassword,onAuthStateChanged
}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import{
getFirestore,collection,addDoc,getDoc,
getDocs,query,orderBy,where,doc,updateDoc
}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import{
getStorage,ref,uploadBytes,getDownloadURL
}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// ============== –í–°–¢–ê–í–¨ –°–í–û–ô CONFIG =================
const firebaseConfig={
apiKey:"–¢–£–¢",
authDomain:"–¢–£–¢",
projectId:"–¢–£–¢",
storageBucket:"–¢–£–¢",
appId:"–¢–£–¢"
};
// ===================================================

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let currentVideoId=null;
let currentOwner=null;

// –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
window.register=async()=>{

const email=prompt("email");
const pass=prompt("pass");
const nick=prompt("–Ω–∏–∫ –Ω–∞ –∫–∞–Ω–∞–ª–µ");

await createUserWithEmailAndPassword(auth,email,pass);

await addDoc(collection(db,"channels"),{
uid:auth.currentUser.uid,
nick,
subs:0,
verified:false
});

alert("–∞–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω");
}

// –í–•–û–î
window.login=async()=>{
await signInWithEmailAndPassword(
auth,
prompt("email"),
prompt("pass")
);
}

onAuthStateChanged(auth,u=>{
user.innerText=u?u.email:"–≥–æ—Å—Ç—å"
});

// –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û
window.upload=async()=>{

if(!auth.currentUser)return alert("–≤–æ–π–¥–∏—Ç–µ");

const f=file.files[0];
const t=thumb.files[0];

const rv=ref(storage,"videos/"+Date.now()+f.name);
await uploadBytes(rv,f);
const url=await getDownloadURL(rv);

let thumbUrl="";
if(t){
 const rt=ref(storage,"thumbs/"+Date.now()+t.name);
 await uploadBytes(rt,t);
 thumbUrl=await getDownloadURL(rt);
}

await addDoc(collection(db,"videos"),{
title:title.value,
desc:desc.value,
url,
thumb:thumbUrl,
uid:auth.currentUser.uid,
views:0,
likes:0,
time:Date.now()
});

alert("–≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ");
load();
}

// –ì–õ–ê–í–ù–ê–Ø + –ü–û–ò–°–ö
window.load=async()=>{

main.innerHTML="";

let s=await getDocs(
query(collection(db,"videos"),orderBy("time","desc"))
);

s.forEach(d=>{

const v=d.data();

if(search.value &&
 !v.title.toLowerCase()
 .includes(search.value.toLowerCase()))return;

main.innerHTML+=`

<div class="card" onclick="openVideo('${d.id}')">

<img src="${v.thumb||''}" width="100%"/>

<h4>${v.title}</h4>

<div>üëÅ ${v.views||0} | üëç ${v.likes||0}</div>

</div>`;
});
}

// –û–¢–ö–†–´–¢–¨ –í–ò–î–ï–û
window.openVideo=async(id)=>{

currentVideoId=id;

show('player');

const d=await getDoc(doc(db,"videos",id));
const v=d.data();

currentOwner=v.uid;

videoPlayer.src=v.url;
vTitle.innerText=v.title;

await updateDoc(doc(db,"videos",id),{
views:(v.views||0)+1
});

views.innerText=v.views+1;
likes.innerText=v.likes||0;

loadComments();
loadRecs(v.title);

// –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∫–∞–Ω–∞–ª–∞
const ch=await getDocs(
query(collection(db,"channels"),
where("uid","==",v.uid))
);

ch.forEach(c=>{
 subs.innerText=c.data().subs||0
});
}

// –õ–ê–ô–ö
window.likeVideo=async()=>{

const d=await getDoc(doc(db,"videos",currentVideoId));

await updateDoc(doc(db,"videos",currentVideoId),{
likes:(d.data().likes||0)+1
});

likes.innerText=d.data().likes+1;
}

// –ü–û–î–ü–ò–°–ö–ê
window.subChannel=async()=>{

const q=await getDocs(
query(collection(db,"channels"),
where("uid","==",currentOwner))
);

q.forEach(async c=>{

const s=c.data().subs||0;

await updateDoc(doc(db,"channels",c.id),{
subs:s+1,
verified:s+1>=100
});

subs.innerText=s+1;

if(s+1==100)
 alert("–ö–∞–Ω–∞–ª –ø–æ–ª—É—á–∏–ª –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é ‚úî");
});
}

// –ö–û–ú–ú–ï–ù–¢–´
window.addComment=async()=>{

await addDoc(collection(db,"comments"),{
video:currentVideoId,
text:cText.value,
uid:auth.currentUser.uid,
time:Date.now()
});

cText.value="";
loadComments();
}

async function loadComments(){

comments.innerHTML="";

const q=await getDocs(
query(collection(db,"comments"),
where("video","==",currentVideoId))
);

q.forEach(d=>{

comments.innerHTML+=`
<div class="comment">
${d.data().text}
</div>`;
});
}

// –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
async function loadRecs(title){

recs.innerHTML="";

const all=await getDocs(collection(db,"videos"));

all.forEach(d=>{

const v=d.data();

if(v.title
.toLowerCase()
.includes(title.split(" ")[0].toLowerCase())){

recs.innerHTML+=`

<div class="card" onclick="openVideo('${d.id}')">

<img src="${v.thumb}" width="100%"/>

${v.title}

</div>`;
}
});
}

// –°–¢–£–î–ò–Ø –ê–í–¢–û–†–ê
window.showStudio=async()=>{

studio.innerHTML="<h2>–ú–æ–∏ –≤–∏–¥–µ–æ</h2>";

const q=query(collection(db,"videos"),
where("uid","==",auth.currentUser.uid));

const s=await getDocs(q);

s.forEach(d=>{

const v=d.data();

studio.innerHTML+=`

<div class="card">

<h4>${v.title}</h4>

üëÅ ${v.views} | üëç ${v.likes}

</div>`;
});
}

// –ù–ê–í–ò–ì–ê–¶–ò–Ø
window.show=id=>{

main.style.display=id=="main"?"grid":"none";
player.style.display=id=="player"?"block":"none";
upload.style.display=id=="upload"?"block":"none";
studio.style.display=id=="studio"?"block":"none";

if(id=="studio")showStudio();
}

load();

</script>
</body>
</html>
